// Generated by CoffeeScript 1.8.0
var apiScheduleList, getSchedules, lastSchedules, scheduleChanged, schedules, setBadge, showNotification;

schedules = [];

scheduleChanged = false;

lastSchedules = [];

apiScheduleList = "http://douyu.sashi-con.info/api/list";

setBadge = function(text) {
  return chrome.browserAction.setBadgeText({
    text: text
  });
};

showNotification = function() {
  var items, options;
  items = schedules.map(function(s) {
    var start;
    start = s.end.split('～')[0];
    return {
      title: "" + s.begin + " " + start,
      message: s.description
    };
  });
  options = {
    type: "list",
    iconUrl: 'images/icon64.png',
    title: 'douyu schedule updated',
    message: 'heheheh ',
    items: items
  };
  return chrome.notifications.create("6666", options, function(notificationId) {});
};

getSchedules = function() {
  var request;
  request = new XMLHttpRequest();
  request.open("GET", apiScheduleList, true);
  request.onload = function() {
    if (request.status >= 200 && request.status < 400) {
      schedules = JSON.parse(request.responseText);
      if (JSON.stringify(schedules) === JSON.stringify(lastSchedules)) {

      } else {
        setBadge('!');
        showNotification();
      }
      lastSchedules = schedules;
    } else {

    }
  };
  request.onerror = function() {};
  return request.send();
};

(function() {
  console.log("background loaded");
  return setInterval(getSchedules, 5000);
})();
